@import views.html.main

@(userId: Long, userName: String)

@main(s"Selamat datang, $userName!") {
    <div class="bg-gray-50 min-h-screen">
        <header class="bg-blue-600 text-white p-4 flex justify-between items-center shadow">
            <h1 class="text-2xl font-bold">ðŸ“š KLAZBooK STORE</h1>
            <div class="flex items-center space-x-4">
                <span>Halo, @userName ðŸ‘‹</span>
                <a href="/transaction/@userId" class="hover:underline">Riwayat Transaksi</a>
                <a href="/" class="hover:underline">Keluar</a>
            </div>
        </header>

        <main class="p-6 max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Katalog Buku -->
            <div class="lg:col-span-2">
                <h2 class="text-xl font-semibold text-gray-800 mb-6">Silakan Pilih Buku yang ingin dibeli</h2>
                <div id="books-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-6"></div>
            </div>

                <!-- Keranjang + Checkout -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow p-6 border sticky top-6">
                    <h3 class="text-lg font-bold mb-4">ðŸ›’ Keranjang Belanja</h3>
                    <div id="cart-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                    <p id="cart-empty" class="text-gray-500">Keranjang kosong.</p>
                    <div class="flex justify-between mt-4 border-t pt-2">
                        <span class="font-semibold">Subtotal:</span>
                        <span id="total-price" class="font-bold text-green-600">Rp 0</span>
                    </div>
                    <div class="flex justify-between mt-2">
                        <span class="font-semibold">Ongkir:</span>
                        <span id="delivery-price" class="text-gray-600">Rp 10.000</span>
                    </div>
                    <div class="flex justify-between mt-2 text-lg">
                        <span class="font-bold">Total:</span>
                        <span id="grand-total" class="font-bold text-blue-600">Rp 0</span>
                    </div>
                    <button onclick="checkout()"
                    class="mt-4 w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">
                        Checkout
                    </button>
                </div>
            </div>
        </main>
    </div>

        <!-- Modal detail buku -->
    <div id="book-modal" class="fixed inset-0 hidden bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg max-w-md w-full shadow">
            <img id="modal-image" src="@routes.Assets.versioned("images/dummy.png")"
            class="w-40 mx-auto mb-4 rounded">
            <h3 id="modal-title" class="text-xl font-bold"></h3>
            <p id="modal-author" class="text-gray-600"></p>
            <p id="modal-genre" class="text-sm text-gray-500"></p>
            <p id="modal-description" class="text-gray-700 my-2"></p>
            <p class="font-semibold">Harga: <span id="modal-price"></span></p>
            <p class="font-semibold">Stok: <span id="modal-stock"></span></p>

            <div class="flex items-center justify-center mt-4 space-x-4">
                <button onclick="changeQty(-1)" class="px-3 py-1 bg-gray-200 rounded">-</button>
                <span id="qty-display" class="text-lg font-bold">1</span>
                <button onclick="changeQty(1)" class="px-3 py-1 bg-gray-200 rounded">+</button>
            </div>

            <div class="mt-6 flex justify-between">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-400 text-white rounded">Tutup</button>
                <button onclick="addToCart()" class="px-4 py-2 bg-green-600 text-white rounded">Tambah ke Keranjang</button>
            </div>
        </div>
    </div>
}

<script>
        const baseUrl = window.location.origin;
        const userId = @userId;
        const userName = "@userName";

        let allBooks = [];
        let currentBook = null;
        let currentQty = 1;
        let activeCart = null;
        let cartBooks = [];

        const deliveryPrice = 10000; // Ongkir flat Rp 10.000
        const numberFormat = new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR" });

        // Ambil daftar buku
        async function loadBooks() {
            try {
                const res = await fetch(`${baseUrl}/books`);
                const data = await res.json();
                allBooks = data.data;
                renderBooks(allBooks);
            } catch (err) {
                console.error("Gagal load buku:", err);
            }
        }

        function renderBooks(books) {
            const container = document.getElementById("books-container");
            container.innerHTML = "";
            books.forEach(book => {
                container.innerHTML += `
        <div class="bg-white rounded shadow p-4 hover:scale-105 transition cursor-pointer"
             onclick="showBookDetail(${book.id})">
          <img src="@routes.Assets.versioned("images/dummy.png")"
               class="w-full h-40 object-cover rounded mb-2">
          <h4 class="font-bold">${book.title}</h4>
          <p class="text-sm text-gray-600">${book.author}</p>
          <p class="font-semibold text-green-600">${numberFormat.format(book.price)}</p>
        </div>
      `;
            });
        }

        // Modal detail buku
        function showBookDetail(id) {
            currentBook = allBooks.find(b => b.id === id);
            if (!currentBook) return;
            document.getElementById("modal-title").textContent = currentBook.title;
            document.getElementById("modal-author").textContent = `Penulis: ${currentBook.author}`;
            document.getElementById("modal-genre").textContent = `Genre ID: ${currentBook.genre_id}`;
            document.getElementById("modal-description").textContent = currentBook.description || "Tidak ada deskripsi.";
            document.getElementById("modal-price").textContent = numberFormat.format(currentBook.price);
            document.getElementById("modal-stock").textContent = currentBook.stock;
            document.getElementById("qty-display").textContent = "1";
            currentQty = 1;
            document.getElementById("book-modal").classList.remove("hidden");
        }

        function closeModal() {
            document.getElementById("book-modal").classList.add("hidden");
        }

        function changeQty(delta) {
            currentQty += delta;
            if (currentQty < 1) currentQty = 1;
            if (currentQty > currentBook.stock) currentQty = currentBook.stock;
            document.getElementById("qty-display").textContent = currentQty;
        }

        // Ambil/ buat cart
        async function getOrCreateCart() {
            if (activeCart) return activeCart;
            const res = await fetch(`${baseUrl}/cart/id-user/${userId}`);
            const data = await res.json();
            if (data.data.length > 0) {
                activeCart = data.data.find(c => c.status === "active");
            }
            if (!activeCart) {
                const createRes = await fetch(`${baseUrl}/cart`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: userId, price: 0, status: "active" })
                });
                const createData = await createRes.json();
                activeCart = createData.data;
            }
            return activeCart;
        }

        async function addToCart() {
            if (!currentBook) return;
            const cart = await getOrCreateCart();
            await fetch(`${baseUrl}/cartBook`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    cart_id: cart.id,
                    book_id: currentBook.id,
                    qty: currentQty,
                    unit_price: currentBook.price,
                    total_price: currentBook.price * currentQty
                })
            });
            await loadCartBooks();
            closeModal();
        }

        async function loadCartBooks() {
            const cart = await getOrCreateCart();
            const res = await fetch(`${baseUrl}/cartBook/id-cart/${cart.id}`);
            const data = await res.json();
            cartBooks = data.data;
            renderCart();
        }

        function renderCart() {
            const listEl = document.getElementById("cart-list");
            const emptyEl = document.getElementById("cart-empty");
            const totalEl = document.getElementById("total-price");
            const grandTotalEl = document.getElementById("grand-total");

            listEl.innerHTML = "";
            let subtotal = 0;
            if (cartBooks.length === 0) {
                emptyEl.style.display = "block";
            } else {
                emptyEl.style.display = "none";
                cartBooks.forEach(item => {
                    const book = allBooks.find(b => b.id === item.book_id);
                    if (book) {
                        subtotal += item.total_price;
                        listEl.innerHTML += `
            <div class="flex justify-between text-sm border-b py-1">
              <span>${book.title} (x${item.qty})</span>
              <span>${numberFormat.format(item.total_price)}</span>
            </div>
          `;
                    }
                });
            }
            totalEl.textContent = numberFormat.format(subtotal);
            grandTotalEl.textContent = numberFormat.format(subtotal + deliveryPrice);
        }

        // Checkout â†’ buat transaksi langsung
        async function checkout() {
            const cart = await getOrCreateCart();
            if (!cart || cartBooks.length === 0) {
                alert("Keranjang kosong!");
                return;
            }
            let subtotal = cartBooks.reduce((sum, item) => sum + item.total_price, 0);
            let total = subtotal + deliveryPrice;

            const res = await fetch(`${baseUrl}/transaction`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    cart_id: cart.id,
                    cart_price: subtotal,
                    delivery_service_price: deliveryPrice,
                    total_price: total
                })
            });
            const data = await res.json();
            const trx = data.data;
            window.location.href = `/transaction/${trx.id}`;
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadBooks();
            loadCartBooks();
        });
</script>
