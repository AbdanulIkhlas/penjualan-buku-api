@import views.html.main
@import views.html.components.header

@(userId: Long, userName: String)(implicit request: RequestHeader)

@main(s"Selamat datang, $userName!") {
    <div class="bg-gray-50 min-h-screen">
        @header(userName, userId)

        <main class="p-6 max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Katalog Buku -->
            <div class="lg:col-span-2">
                <h2 class="text-xl font-semibold text-gray-800 mb-6">Silakan Pilih Buku yang ingin dibeli</h2>
                <div id="books-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-6"></div>
            </div>

            <!-- Keranjang + Checkout -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow p-6 border sticky top-6">
                    <h3 class="text-lg font-bold mb-4">Keranjang Belanja</h3>
                    <div id="cart-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                    <p id="cart-empty" class="text-gray-500">Keranjang kosong.</p>
                    <div class="flex justify-between mt-4 border-t pt-2">
                        <span class="font-semibold">Subtotal:</span>
                        <span id="total-price" class="font-bold text-green-600">Rp 0</span>
                    </div>
                    <div class="flex justify-between mt-2">
                        <span class="font-semibold">Ongkir:</span>
                        <span id="delivery-price" class="text-gray-600">Rp 10.000</span>
                    </div>
                    <div class="flex justify-between mt-2 text-lg">
                        <span class="font-bold">Total:</span>
                        <span id="grand-total" class="font-bold text-blue-600">Rp 0</span>
                    </div>
                    <button onclick="checkout()"
                    class="mt-4 w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">
                        Checkout
                    </button>
                </div>
            </div>
        </main>
    </div>

        <!-- Modal detail buku -->
    <div id="book-modal" class="fixed inset-0 hidden bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg max-w-md w-full shadow">
            <img id="modal-image" src="@routes.Assets.versioned("images/dummy.png")"
            class="w-40 mx-auto mb-4 rounded">
            <h3 id="modal-title" class="text-xl font-bold"></h3>
            <p id="modal-author" class="text-gray-600"></p>
            <p id="modal-genre" class="text-sm text-gray-500"></p>
            <p id="modal-description" class="text-gray-700 my-2"></p>
            <p class="font-semibold">Harga: <span id="modal-price"></span></p>
            <p class="font-semibold">Stok: <span id="modal-stock"></span></p>

            <div class="flex items-center justify-center mt-4 space-x-4">
                <button type="button" onclick="changeQty(-1)" class="px-3 py-1 bg-gray-200 rounded">-</button>
                <span id="qty-display" class="text-lg font-bold">0</span>
                <button type="button" onclick="changeQty(1)" class="px-3 py-1 bg-gray-200 rounded">+</button>
            </div>

            <button type="button" id="btn-add-cart" class="mt-6 w-full px-4 py-2 bg-green-600 text-white rounded">
                Tambah ke Keranjang
            </button>

            <button type="button" onclick="closeModal()" class="mt-4 px-4 py-2 bg-gray-400 text-white rounded w-full">
                Tutup
            </button>
        </div>
    </div>
}

<script>
        const baseUrl = window.location.origin;
        const userId = @userId;
        let allBooks = [];
        let currentBook = null;
        let currentQty = 1;
        let activeCart = null;
        let cartBooks = [];
        const deliveryPrice = 10000;
        const numberFormat = new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR" });

        // Ambil CSRF token Play Framework
        const csrfToken = '@helper.CSRF.getToken.value';

        // Load buku
        async function loadBooks() {
            const res = await fetch(`${baseUrl}/books`);
            const data = await res.json();
            allBooks = data.data;
            renderBooks(allBooks);
        }

        // tampilkan semua buku
        function renderBooks(books) {
            const container = document.getElementById("books-container");
            container.innerHTML = "";

            // Urutkan buku berdasarkan judul (A-Z)
            books.sort((a, b) => a.title.localeCompare(b.title));

            books.forEach(book => {
                container.innerHTML += `
            <div class="bg-white rounded shadow p-4 hover:scale-105 transition cursor-pointer"
                 onclick="showBookDetail(${book.id})">
              <img src="@routes.Assets.versioned("images/dummy.png")"
                   class="w-full h-40 object-cover rounded mb-2">
              <h4 class="font-bold">${book.title}</h4>
              <p class="text-sm text-gray-600">${book.author}</p>
              <p class="font-semibold text-green-600">${numberFormat.format(book.price)}</p>
            </div>
        `;
            });
        }


        // Ambil data buku terbaru dari backend
        async function refreshBook(bookId) {
            const res = await fetch(`${baseUrl}/books/${bookId}`);
            const data = await res.json();
            return data.data;
        }

        // get genre buku
        async function getGenre(id) {
            console.log("id genre : ", id);
            const res = await fetch(`${baseUrl}/genres/${id}`);
            const data = await res.json();
            console.log("genre : ", data.data);
            return data.data.name;
        }

        // Modal buku
        async function showBookDetail(id) {
            // Ambil data terbaru buku dari backend
            currentBook = await refreshBook(id);
            console.log("currentBook : ", currentBook);
            genresBook = await getGenre(currentBook.genre_id);
            if (!currentBook) return;
            currentQty = 0;

            document.getElementById("modal-title").textContent = currentBook.title;
            document.getElementById("modal-author").textContent = `Penulis: ${currentBook.author}`;
            document.getElementById("modal-genre").textContent = `Genre : ${genresBook}`;
            document.getElementById("modal-description").textContent = currentBook.description || "Tidak ada deskripsi.";
            document.getElementById("modal-price").textContent = numberFormat.format(currentBook.price);

            // stok dinamis
            document.getElementById("modal-stock").textContent = currentBook.stock;

            document.getElementById("qty-display").textContent = currentQty;
            document.getElementById("book-modal").classList.remove("hidden");
        }


        function closeModal() {
            document.getElementById("book-modal").classList.add("hidden");
        }

        function changeQty(qty) {
            if (!currentBook) return;
            currentQty += qty;
            if (currentQty < 1) currentQty = 0;
            if (currentQty > currentBook.stock) currentQty = currentBook.stock;
            document.getElementById("qty-display").textContent = currentQty;
        }

        // Ambil / buat cart
        async function getOrCreateCart() {
            if (activeCart) return activeCart;

            // Ambil semua cart user
            const res = await fetch(`${baseUrl}/cart/id-user/${userId}`);
            const data = await res.json();

            // Cari cart dengan status active
            activeCart = data.data.find(c => c.status === "active");

            // Kalau tidak ada, buat cart baru dengan status active
            if (!activeCart) {
                const createRes = await fetch(`${baseUrl}/cart`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Csrf-Token": csrfToken
                    },
                    credentials: "same-origin",
                    body: JSON.stringify({ user_id: userId, price: 0, status: "active" })
                });
                const createData = await createRes.json();
                activeCart = createData.data;
            }

            return activeCart;
        }


        // Tambah ke keranjang (AJAX)
        async function addToCart() {
            if (!currentBook) return;
            const cart = await getOrCreateCart();

            await fetch(`${baseUrl}/cartBook`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Csrf-Token": csrfToken
                },
                credentials: "same-origin",
                body: JSON.stringify({
                    cart_id: cart.id,
                    book_id: currentBook.id,
                    qty: currentQty,
                    unit_price: currentBook.price,
                    total_price: currentBook.price * currentQty,
                    is_delete_cart_books: false
                })
            });

            await loadCartBooks();
            closeModal();
        }

        // Hapus item dari keranjang (soft delete) dan reload stok buku
        async function deleteCartBook(cartBookId) {
            if (!confirm("Hapus item ini dari keranjang?")) return;

            const res = await fetch(`${baseUrl}/cartBook/${cartBookId}`, {
                method: "DELETE",
                headers: {
                    "Csrf-Token": csrfToken
                },
                credentials: "same-origin"
            });

            const data = await res.json();

            // Reload cartBooks
            await loadCartBooks();

            // Update stok di modal jika modal buku yang dihapus sama dengan currentBook
            if (currentBook) {
                // Ambil data terbaru buku dari allBooks
                const updatedBook = allBooks.find(b => b.id === currentBook.id);
                if (updatedBook) {
                    document.getElementById("modal-stock").textContent = updatedBook.stock;
                }
            }
        }


        // Load keranjang
        async function loadCartBooks() {
            const cart = await getOrCreateCart();
            const res = await fetch(`${baseUrl}/cartBook/id-cart/${cart.id}`);
            const data = await res.json();
            console.log("data cartbook: ", data);
            cartBooks = data.data;
            renderCart();
        }

        function renderCart() {
            const listEl = document.getElementById("cart-list");
            const emptyEl = document.getElementById("cart-empty");
            const totalEl = document.getElementById("total-price");
            const deliveryEl = document.getElementById("delivery-price");
            const grandTotalEl = document.getElementById("grand-total");

            listEl.innerHTML = "";
            let subtotal = 0;

            const activeCartBooks = cartBooks.filter(item => !item.is_delete_cart_books);

            if (activeCartBooks.length === 0) {
                emptyEl.style.display = "block";
            } else {
                emptyEl.style.display = "none";
                activeCartBooks.forEach(item => {
                    const book = allBooks.find(b => b.id === item.book_id);
                    if (book) {
                        subtotal += item.total_price;
                        listEl.innerHTML += `
                    <div class="flex justify-between text-sm border-b py-1 items-center">
                        <span>${book.title} (x${item.qty})</span>
                        <span class="flex items-center space-x-2">
                            <span>${numberFormat.format(item.total_price)}</span>
                            <button onclick="deleteCartBook(${item.id})"
                                class="text-red-500 hover:text-red-700">
                                🗑️
                            </button>
                        </span>
                    </div>
                `;
                    }
                });
            }

            totalEl.textContent = numberFormat.format(subtotal);

            // ongkir 10% dari subtotal
            const deliveryPriceDynamic = subtotal * 0.10;
            deliveryEl.textContent = numberFormat.format(deliveryPriceDynamic);

            grandTotalEl.textContent = numberFormat.format(subtotal + deliveryPriceDynamic);
        }



        // Checkout
        async function checkout() {
            const cart = await getOrCreateCart();
            if (!cart || cartBooks.length === 0) {
                alert("Keranjang kosong!");
                return;
            }

            let subtotal = cartBooks.reduce((sum, item) => sum + item.total_price, 0);
            let total = subtotal + deliveryPrice;

            const res = await fetch(`${baseUrl}/transaction`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Csrf-Token": csrfToken
                },
                credentials: "same-origin",
                body: JSON.stringify({
                    cart_id: cart.id,
                    cart_price: subtotal,
                    delivery_service_price: deliveryPrice,
                    total_price: total
                })
            });

            const data = await res.json();
            if(data.status === "success") {
                // redirect ke riwayat transaksi user
                window.location.href = `/history/${userId}/${encodeURIComponent('@userName')}`;
            } else {
                alert("Checkout gagal: " + data.message);
            }
        }


        // Event tombol modal
        document.getElementById("btn-add-cart").addEventListener("click", addToCart);

        document.addEventListener("DOMContentLoaded", () => {
            loadBooks();
            loadCartBooks();
        });
</script>

