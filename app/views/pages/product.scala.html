@import views.html.main
@import views.html.components.header

@(userId: Long, userName: String)(implicit request: RequestHeader)

@main(s"Selamat datang, $userName!") {
    <div class="bg-gray-50 min-h-screen">
        @header(userName, userId)
        <main class="p-6 pt-10 max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Katalog Buku -->
            <div class="lg:col-span-2">
                <h2 class="text-2xl font-bold text-blue-900 mb-6 flex items-center gap-2">
                        <!-- Icon Buku -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 6V4m0 2v2m0 4v6m8-10H4m16 0v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6h16z"/>
                    </svg>
                    Silakan Pilih Buku yang Ingin Dibeli
                </h2>
                <div id="books-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-6"></div>
            </div>

                <!-- Keranjang + Checkout -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-xl p-6 sticky top-6 border border-blue-100">
                    <h3 class="text-xl font-bold text-blue-800 mb-4 flex items-center gap-2">
                            <!-- Icon Cart -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13l-1.35 6.72A2 2 0 007.6 22h8.8a2 2 0 001.95-2.28L17 13M7 13h10"/>
                        </svg>
                        Keranjang Belanja
                    </h3>
                    <div id="cart-list" class="space-y-3 max-h-60 overflow-y-auto"></div>
                    <p id="cart-empty" class="text-gray-500 text-center">Keranjang kosong.</p>

                    <div class="mt-4 border-t pt-3 space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="font-semibold text-gray-700">Subtotal:</span>
                            <span id="total-price" class="font-bold text-blue-700">Rp 0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold text-gray-700">Ongkir:</span>
                            <span id="delivery-price" class="text-gray-600">Rp 10.000</span>
                        </div>
                        <div class="flex justify-between text-lg">
                            <span class="font-bold text-gray-900">Total:</span>
                            <span id="grand-total" class="font-bold text-blue-800">Rp 0</span>
                        </div>
                    </div>

                    <button onclick="checkout()"
                    class="mt-5 w-full bg-gradient-to-r from-blue-600 to-blue-800 text-white py-2 rounded-xl shadow-md hover:shadow-lg hover:scale-[1.02] transition duration-300">
                        Checkout
                    </button>
                </div>
            </div>
        </main>
    </div>

        <!-- Modal detail buku -->
    <div id="book-modal" class="fixed inset-0 hidden bg-gray-800 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-2xl max-w-md w-full shadow-xl border border-blue-100">
            <img id="modal-image" src="@routes.Assets.versioned("images/dummy.png")"
            class="w-40 mx-auto mb-4 rounded-lg shadow">
            <h3 id="modal-title" class="text-xl font-bold text-blue-800"></h3>
            <p id="modal-author" class="text-gray-600"></p>
            <p id="modal-genre" class="text-sm text-blue-500 font-medium"></p>
            <p id="modal-description" class="text-gray-700 my-2"></p>
            <p class="font-semibold">Harga: <span id="modal-price" class="text-blue-700"></span></p>
            <p class="font-semibold">Stok: <span id="modal-stock" class="text-gray-700"></span></p>

            <div class="flex items-center justify-center mt-4 space-x-4">
                <button type="button" onclick="changeQty(-1)"
                class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">-</button>
                <span id="qty-display" class="text-lg font-bold text-blue-800">0</span>
                <button type="button" onclick="changeQty(1)"
                class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">+</button>
            </div>

            <button type="button" id="btn-add-cart"
            class="mt-6 w-full px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-lg shadow hover:scale-[1.02] transition">
                Tambah ke Keranjang
            </button>

            <button type="button" onclick="closeModal()"
            class="mt-3 w-full px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500">
                Tutup
            </button>
        </div>
    </div>
}

<script>
        const baseUrl = window.location.origin;
        const userId = @userId;
        let allBooks = [];
        let currentBook = null;
        let currentQty = 1;
        let activeCart = null;
        let cartBooks = [];
        const deliveryPrice = 10000;
        const numberFormat = new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR" });

        // Ambil CSRF token Play Framework
        const csrfToken = '@helper.CSRF.getToken.value';

        // Load buku
        async function loadBooks() {
            const res = await fetch(`${baseUrl}/books`);
            const data = await res.json();
            allBooks = data.data;
            renderBooks(allBooks);
        }

        // tampilkan semua buku
        function renderBooks(books) {
            const container = document.getElementById("books-container");
            container.innerHTML = "";

            // Urutkan buku berdasarkan judul (A-Z)
            books.sort((a, b) => a.title.localeCompare(b.title));

            books.forEach(book => {
                container.innerHTML += `
            <div class="bg-white rounded shadow p-4 hover:scale-105 transition cursor-pointer"
                 onclick="showBookDetail(${book.id})">
              <img src="@routes.Assets.versioned("images/dummy.png")"
                   class="w-full h-40 object-cover rounded mb-2">
              <h4 class="font-bold">${book.title}</h4>
              <p class="text-sm text-gray-600">${book.author}</p>
              <p class="font-semibold text-green-600">${numberFormat.format(book.price)}</p>
            </div>
        `;
            });
        }


        // Ambil data buku terbaru dari backend
        async function refreshBook(bookId) {
            const res = await fetch(`${baseUrl}/books/${bookId}`);
            const data = await res.json();
            return data.data;
        }

        // get genre buku
        async function getGenre(id) {
            console.log("id genre : ", id);
            const res = await fetch(`${baseUrl}/genres/${id}`);
            const data = await res.json();
            console.log("genre : ", data.data);
            return data.data.name;
        }

        // Modal buku
        async function showBookDetail(id) {
            // Ambil data terbaru buku dari backend
            currentBook = await refreshBook(id);
            console.log("currentBook : ", currentBook);
            genresBook = await getGenre(currentBook.genre_id);
            if (!currentBook) return;
            currentQty = 0;

            document.getElementById("modal-title").textContent = currentBook.title;
            document.getElementById("modal-author").textContent = `Penulis: ${currentBook.author}`;
            document.getElementById("modal-genre").textContent = `Genre : ${genresBook}`;
            document.getElementById("modal-description").textContent = currentBook.description || "Tidak ada deskripsi.";
            document.getElementById("modal-price").textContent = numberFormat.format(currentBook.price);

            // stok dinamis
            document.getElementById("modal-stock").textContent = currentBook.stock;

            document.getElementById("qty-display").textContent = currentQty;
            document.getElementById("book-modal").classList.remove("hidden");
        }


        function closeModal() {
            document.getElementById("book-modal").classList.add("hidden");
        }

        function changeQty(qty) {
            if (!currentBook) return;
            currentQty += qty;
            if (currentQty < 1) currentQty = 0;
            if (currentQty > currentBook.stock) currentQty = currentBook.stock;
            document.getElementById("qty-display").textContent = currentQty;
        }

        // Ambil / buat cart
        async function getOrCreateCart() {
            if (activeCart) return activeCart;

            // Ambil semua cart user
            const res = await fetch(`${baseUrl}/cart/id-user/${userId}`);
            const data = await res.json();

            // Cari cart dengan status active
            activeCart = data.data.find(c => c.status === "active");

            // Kalau tidak ada, buat cart baru dengan status active
            if (!activeCart) {
                const createRes = await fetch(`${baseUrl}/cart`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Csrf-Token": csrfToken
                    },
                    credentials: "same-origin",
                    body: JSON.stringify({ user_id: userId, price: 0, status: "active" })
                });
                const createData = await createRes.json();
                activeCart = createData.data;
            }

            return activeCart;
        }


        // Tambah ke keranjang (AJAX)
        async function addToCart() {
            if (!currentBook) return;
            const cart = await getOrCreateCart();

            await fetch(`${baseUrl}/cartBook`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Csrf-Token": csrfToken
                },
                credentials: "same-origin",
                body: JSON.stringify({
                    cart_id: cart.id,
                    book_id: currentBook.id,
                    qty: currentQty,
                    unit_price: currentBook.price,
                    total_price: currentBook.price * currentQty,
                    is_delete_cart_books: false
                })
            });

            await loadCartBooks();
            closeModal();
        }

        // Hapus item dari keranjang (soft delete) dan reload stok buku
        async function deleteCartBook(cartBookId) {
            if (!confirm("Hapus item ini dari keranjang?")) return;

            const res = await fetch(`${baseUrl}/cartBook/${cartBookId}`, {
                method: "DELETE",
                headers: {
                    "Csrf-Token": csrfToken
                },
                credentials: "same-origin"
            });

            const data = await res.json();

            // Reload cartBooks
            await loadCartBooks();

            // Update stok di modal jika modal buku yang dihapus sama dengan currentBook
            if (currentBook) {
                // Ambil data terbaru buku dari allBooks
                const updatedBook = allBooks.find(b => b.id === currentBook.id);
                if (updatedBook) {
                    document.getElementById("modal-stock").textContent = updatedBook.stock;
                }
            }
        }


        // Load keranjang
        async function loadCartBooks() {
            const cart = await getOrCreateCart();
            const res = await fetch(`${baseUrl}/cartBook/id-cart/${cart.id}`);
            const data = await res.json();
            console.log("data cartbook: ", data);
            cartBooks = data.data;
            renderCart();
        }

        function renderCart() {
            const listEl = document.getElementById("cart-list");
            const emptyEl = document.getElementById("cart-empty");
            const totalEl = document.getElementById("total-price");
            const deliveryEl = document.getElementById("delivery-price");
            const grandTotalEl = document.getElementById("grand-total");

            listEl.innerHTML = "";
            let subtotal = 0;

            const activeCartBooks = cartBooks.filter(item => !item.is_delete_cart_books);

            if (activeCartBooks.length === 0) {
                emptyEl.style.display = "block";
            } else {
                emptyEl.style.display = "none";
                activeCartBooks.forEach(item => {
                    const book = allBooks.find(b => b.id === item.book_id);
                    if (book) {
                        subtotal += item.total_price;
                        listEl.innerHTML += `
                    <div class="flex justify-between text-sm border-b py-1 items-center">
                        <span>${book.title} (x${item.qty})</span>
                        <span class="flex items-center space-x-2">
                            <span>${numberFormat.format(item.total_price)}</span>
                            <button onclick="deleteCartBook(${item.id})"
                                class="w-5 h-5 p-1 flex items-center justify-center bg-red-500 text-white rounded hover:cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                                </svg>

                            </button>
                        </span>
                    </div>
                `;
                    }
                });
            }

            totalEl.textContent = numberFormat.format(subtotal);

            // ongkir 10% dari subtotal
            const deliveryPriceDynamic = subtotal * 0.10;
            deliveryEl.textContent = numberFormat.format(deliveryPriceDynamic);

            grandTotalEl.textContent = numberFormat.format(subtotal + deliveryPriceDynamic);
        }



        // Checkout
        async function checkout() {
            const cart = await getOrCreateCart();
            if (!cart || cartBooks.length === 0) {
                alert("Keranjang kosong!");
                return;
            }

            let subtotal = cartBooks.reduce((sum, item) => sum + item.total_price, 0);
            let total = subtotal + deliveryPrice;

            const res = await fetch(`${baseUrl}/transaction`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Csrf-Token": csrfToken
                },
                credentials: "same-origin",
                body: JSON.stringify({
                    cart_id: cart.id,
                    cart_price: subtotal,
                    delivery_service_price: deliveryPrice,
                    total_price: total
                })
            });

            const data = await res.json();
            if(data.status === "success") {
                // redirect ke riwayat transaksi user
                window.location.href = `/history/${userId}/${encodeURIComponent('@userName')}`;
            } else {
                alert("Checkout gagal: " + data.message);
            }
        }


        // Event tombol modal
        document.getElementById("btn-add-cart").addEventListener("click", addToCart);

        document.addEventListener("DOMContentLoaded", () => {
            loadBooks();
            loadCartBooks();
        });
</script>

