@import views.html.main
@import views.html.components.header
@import models.Genre
@import helper._

@(userId: Long, userName: String, genres: Seq[Genre])(implicit request: RequestHeader)

@main(s"Tambah Buku - $userName") {
    <div class="min-h-screen bg-blue-50 text-gray-800 font-sans antialiased">
        @header(userName, userId)

        <main class="max-w-3xl mx-auto px-4 py-8 sm:py-12 lg:py-16">
            <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 lg:p-10 border border-blue-100">
                <div class="flex items-center justify-center gap-4 mb-8">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-10 h-10 text-blue-600">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.002 0-2.002.248-2.903.711A3.498 3.498 0 003 7.5v11.25c0 1.05-.684 1.902-1.666 2.25a.5.5 0 00-.334.693 2.153 2.153 0 01-1.25 1.5c-.328.214-.528.513-.67.842-.14.33-.21.684-.21 1.054a3.75 3.75 0 003.75 3.75c.675 0 1.334-.144 1.954-.421a3.75 3.75 0 001.996-1.579c.621-.621 1.054-1.293 1.254-1.63a3.75 3.75 0 00-.67-1.408c.14-.33.21-.684.21-1.054a3.75 3.75 0 00-3.75-3.75c-.675 0-1.334.144-1.954.421a3.75 3.75 0 00-1.996 1.579c-.621.621-1.054 1.293-1.254 1.63a3.75 3.75 0 00.67 1.408z" />
                    </svg>
                    <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-900 tracking-tight leading-tight">Tambah Buku Baru</h1>
                </div>

                <form id="bookForm" class="space-y-6">
                    <input type="hidden" name="userId" value="@userId"/>
                    <input type="hidden" name="image_url" value="dummy.png"/>

                    <div>
                        <label for="title" class="block text-sm font-semibold text-gray-700 mb-1">Judul Buku</label>
                        <input type="text" id="title" name="title" required
                        class="w-full rounded-xl border border-gray-300 shadow-sm px-4 py-3 bg-gray-50 text-gray-800 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"/>
                    </div>

                    <div>
                        <label for="author" class="block text-sm font-semibold text-gray-700 mb-1">Penulis</label>
                        <input type="text" id="author" name="author" required
                        class="w-full rounded-xl border border-gray-300 shadow-sm px-4 py-3 bg-gray-50 text-gray-800 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"/>
                    </div>

                    <div>
                        <label for="description" class="block text-sm font-semibold text-gray-700 mb-1">Deskripsi</label>
                        <textarea id="description" name="description" rows="3"
                        class="w-full rounded-xl border border-gray-300 shadow-sm px-4 py-3 bg-gray-50 text-gray-800 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="price" class="block text-sm font-semibold text-gray-700 mb-1">Harga (Rp)</label>
                            <input type="number" step="0.01" id="price" name="price" required
                            class="w-full rounded-xl border border-gray-300 shadow-sm px-4 py-3 bg-gray-50 text-gray-800 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"/>
                        </div>

                        <div>
                            <label for="stock" class="block text-sm font-semibold text-gray-700 mb-1">Stok</label>
                            <input type="number" name="stock" id="stock" min="0" required
                            class="w-full rounded-xl border border-gray-300 shadow-sm px-4 py-3 bg-gray-50 text-gray-800 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"/>
                        </div>
                    </div>

                    <div>
                        <label for="genre_id" class="block text-sm font-semibold text-gray-700 mb-1">Genre</label>
                        <select id="genre_id" name="genre_id" required
                        class="w-full rounded-xl border border-gray-300 shadow-sm px-4 py-3 bg-gray-50 text-gray-800 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">-- Pilih Genre --</option>
                            @for(genre <- genres) {
                                <option value="@genre.id.getOrElse(0)">@genre.name</option>
                            }
                        </select>
                    </div>

                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="resetBtn"
                        class="inline-flex items-center px-6 py-3 rounded-xl bg-gray-200 text-gray-700 font-bold hover:bg-gray-300 transition-colors duration-200">
                            Batal
                        </button>
                        <button type="submit"
                        class="inline-flex items-center px-6 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 transition-colors duration-200">
                            Simpan Buku
                        </button>
                    </div>
                </form>

                <div id="resultMessage" class="mt-6 text-center text-sm font-medium"></div>
            </div>
        </main>
    </div>

    <script>
            const csrfToken = '@helper.CSRF.getToken.value';
            const bookForm = document.getElementById("bookForm");
            const resultMessage = document.getElementById("resultMessage");
            const baseUrl = window.location.origin;

            document.getElementById("resetBtn").addEventListener("click", function() {
                bookForm.reset();
                resultMessage.innerText = "";
                resultMessage.className = "mt-6 text-center text-sm font-medium"; // Reset class
            });

            bookForm.addEventListener("submit", async function(e) {
                e.preventDefault();

                resultMessage.innerText = "Mengirim data...";
                resultMessage.className = "mt-6 text-center text-sm font-medium text-gray-500";

                const formData = new FormData(this);
                const data = {};
                formData.forEach((value, key) => {
                    if (["price", "stock", "userId", "genre_id"].includes(key)) {
                        data[key] = Number(value);
                    } else {
                        data[key] = value;
                    }
                });

                try {
                    const response = await fetch(`${baseUrl}/books`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Csrf-Token": csrfToken
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        resultMessage.innerText = "Buku berhasil ditambahkan!";
                        resultMessage.classList.remove("text-red-500", "text-gray-500");
                        resultMessage.classList.add("text-green-600");
                        this.reset();
                    } else {
                        const err = await response.json();
                        resultMessage.innerText = `Gagal menambahkan buku: ${err.message || response.statusText}`;
                        resultMessage.classList.remove("text-green-600", "text-gray-500");
                        resultMessage.classList.add("text-red-500");
                    }
                } catch (error) {
                    resultMessage.innerText = `Error: ${error.message}`;
                    resultMessage.classList.remove("text-green-600", "text-gray-500");
                    resultMessage.classList.add("text-red-500");
                }
            });
    </script>
}